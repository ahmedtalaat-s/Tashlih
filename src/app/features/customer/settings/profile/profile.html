<div class="profile-upload">
  <div class="avatar-placeholder">
    <!-- CASE 1: Avatar exists -->
    @if (user?.avatarUrl) {
      <img [src]="user?.avatarUrl" alt="Profile Image" class="avatar-image" />

      <!-- delete icon -->
      <button class="delete-icon" (click)="removeAvatar()">
        <lucide-icon [img]="TrashIcon" size="18"></lucide-icon>
      </button>
    }

    <!-- CASE 2: No avatar -->
    @else {
      <lucide-icon [img]="UserIcon" size="40" color="#bbb" class="main-avatar-icon"></lucide-icon>

      <button class="camera-icon-wrapper" (click)="fileInput.click()">
        <lucide-icon [img]="CameraIcon" size="18"></lucide-icon>
      </button>
    }

    <!-- hidden file input -->
    <input #fileInput type="file" accept="image/*" hidden (change)="onImageSelected($event)" />
  </div>

  @if (!user?.avatarUrl) {
    <p class="upload-text">اضف صورة شخصية</p>
  }
</div>

<div class="form-section personal-info">
  <span class="section-header">معلوماتك الشخصية</span>

  <div class="input-group">
    <div class="input-field" [class.is-editing]="editingField === 'fullName'">
      <lucide-icon [img]="UserIcon" size="16" class="field-leading-icon"></lucide-icon>

      <input
        type="text"
        name="fullName"
        class="form-input"
        [(ngModel)]="form.fullName"
        #fullName="ngModel"
        required
        minlength="3"
        [disabled]="editingField !== 'fullName'"
      />

      @if (editingField !== 'fullName') {
        <lucide-icon
          [img]="Pen"
          size="16"
          class="icon-muted pen-tool"
          (click)="enableEdit('fullName')"
        ></lucide-icon>
      }

      @if (editingField === 'fullName') {
        <div class="field-actions inline-actions">
          <button class="btn-confirm" (click)="saveField()" [disabled]="fullName.invalid">
            حفظ
          </button>
          <button class="btn-discard" (click)="cancelEdit()">إلغاء</button>
        </div>
      }

      @if (fullName.invalid && fullName.touched) {
        <small class="error-msg">الاسم مطلوب (٣ حروف على الأقل)</small>
      }
    </div>

    <div class="input-field field-readonly">
      <lucide-icon [img]="PhoneIcon" size="16" class="field-leading-icon"></lucide-icon>
      <input type="text" class="form-input" [value]="user?.phone?.split('+')?.at(1)" disabled />
    </div>

    <div class="input-field" [class.is-editing]="editingField === 'email'">
      <lucide-icon [img]="MailIcon" size="16" class="field-leading-icon"></lucide-icon>

      <input
        type="email"
        name="email"
        class="form-input"
        [(ngModel)]="form.email"
        #email="ngModel"
        required
        email
        [disabled]="editingField !== 'email'"
      />

      @if (editingField !== 'email') {
        <lucide-icon
          [img]="Pen"
          size="16"
          class="icon-muted pen-tool"
          (click)="enableEdit('email')"
        ></lucide-icon>
      }

      @if (editingField === 'email') {
        <div class="field-actions inline-actions">
          <button class="btn-confirm" (click)="saveField()" [disabled]="email.invalid">حفظ</button>
          <button class="btn-discard" (click)="cancelEdit()">إلغاء</button>
        </div>
      }

      @if (email.invalid && email.touched) {
        <small class="error-msg">بريد إلكتروني غير صالح</small>
      }
    </div>
  </div>
</div>

<div class="form-section address-section">
  <span class="section-header">العنوان</span>

  @if (!editingAddress) {
    <div class="address-display-box address">
      <div class="address-text-container">
        {{ addressExists ? addressText : 'لا يوجد عنوان مسجل' }}
      </div>

      <button class="btn-action-outline btn-add-address" (click)="editAddress()">
        <lucide-icon [img]="MapPinIcon" size="16"></lucide-icon>
        <span class="btn-text">{{ addressExists ? 'تعديل العنوان' : 'اضف عنوان' }}</span>
      </button>
    </div>
  }

  @if (editingAddress) {
    <div class="address-form-container">
      <input
        type="text"
        class="form-input-bordered"
        placeholder="الشارع"
        [(ngModel)]="addressForm.street"
        required
      />

      <select class="form-select-custom" [(ngModel)]="addressForm.cityId">
        <option value="" disabled>اختر المدينة</option>
        @for (city of cities; track city.id) {
          <option [value]="city.id">
            {{ city.nameAr }}
          </option>
        }
      </select>

      <input
        type="text"
        class="form-input-bordered"
        placeholder="الرمز البريدي"
        [(ngModel)]="addressForm.postalCode"
      />

      <div class="field-actions full-width-actions">
        <button
          class="btn-confirm"
          (click)="saveAddress()"
          [disabled]="!addressForm.street || !addressForm.cityId"
        >
          حفظ
        </button>
        <button class="btn-discard" (click)="cancelAddress()">إلغاء</button>
      </div>
    </div>
  }
</div>

<div class="form-section password-section">
  <span class="section-header">تغيير كلمة المرور</span>

  <div class="password-input-container">
    <div class="password-input">
      <input
        type="password"
        class="form-input"
        placeholder="كلمة المرور الحالية"
        [(ngModel)]="passwordForm.oldPassword"
      />
    </div>

    <div class="password-input">
      <input
        type="password"
        class="form-input"
        placeholder="كلمة المرور الجديدة"
        [(ngModel)]="passwordForm.newPassword"
        minlength="6"
      />
    </div>

    <div class="password-input">
      <input
        type="password"
        class="form-input"
        placeholder="تأكيد كلمة المرور الجديدة"
        [(ngModel)]="passwordForm.confirmPassword"
      />
    </div>

    @if (passwordMismatch) {
      <small class="error-msg">كلمتا المرور غير متطابقتين</small>
    }

    <div class="form-submit-container">
      <button class="btn-save-main" (click)="changePassword()" [disabled]="!canChangePassword">
        حفظ كلمة المرور
      </button>
    </div>
  </div>
</div>
